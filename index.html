<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Diagnostic Terminal</title>
<style>
/* CSS VARIABLES FOR THEMING */
:root {
  --bg-primary: #f5f7fa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #e8ecf1;
  --text-primary: #2d3748;
  --text-secondary: #4a5568;
  --accent-primary: #3182ce;
  --accent-secondary: #2c5282;
  --border-color: #cbd5e0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  --success-color: #38a169;
  --error-color: #e53e3e;
  --warning-color: #dd6b20;
  --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  --border-radius: 8px;
}

body.retro-theme {
  --bg-primary: #1e1e1e;
  --bg-secondary: #000000;
  --bg-tertiary: #2e2e2e;
  --text-primary: #00ff00;
  --text-secondary: #00cc00;
  --accent-primary: #00ff00;
  --accent-secondary: #00cc00;
  --border-color: #00ff00;
  --shadow-sm: 0 0 5px rgba(0, 255, 0, 0.2);
  --shadow-md: 0 0 10px rgba(0, 255, 0, 0.2);
  --shadow-lg: 0 0 15px rgba(0, 255, 0, 0.3);
  --success-color: #00ff00;
  --error-color: #ff0000;
  --warning-color: #ff6600;
  --font-main: 'Courier New', monospace;
  --font-mono: 'Courier New', monospace;
}

* { box-sizing: border-box; }

body {
  font-family: var(--font-main);
  background: var(--bg-primary);
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.container {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.dev-banner {
  background: linear-gradient(135deg, #ff6600 0%, #ff8800 100%);
  color: #000;
  padding: 15px;
  text-align: center;
  font-weight: bold;
  font-size: 1.1rem;
  border-bottom: 3px solid #ff3300;
  animation: pulse 2s infinite;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

@keyframes pulse {
  0%, 100% { background: linear-gradient(135deg, #ff6600 0%, #ff8800 100%); }
  50% { background: linear-gradient(135deg, #ff8800 0%, #ffaa00 100%); }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

h1 {
  color: var(--text-primary);
  border-bottom: 3px solid var(--accent-primary);
  padding-bottom: 15px;
  margin: 0;
  font-size: 2rem;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-controls {
  display: flex;
  gap: 15px;
  align-items: center;
}

.theme-toggle {
  background: var(--bg-secondary);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-primary);
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
  display: flex;
  align-items: center;
  gap: 8px;
}

.theme-toggle:hover {
  background: var(--bg-tertiary);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.api-docs-btn {
  background: var(--accent-primary);
  border: none;
  border-radius: var(--border-radius);
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 600;
  color: white;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.api-docs-btn:hover {
  background: var(--accent-secondary);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: var(--shadow-md);
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: var(--shadow-lg);
}

.card-header {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border-color);
}

.tool-form {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  align-items: stretch;
  flex-wrap: wrap;
}

input, select, button {
  padding: 12px 16px;
  font-size: 0.95rem;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-family: var(--font-main);
  transition: all 0.2s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}

button {
  cursor: pointer;
  font-weight: 600;
  background: var(--accent-primary);
  color: white;
  border: none;
}

button:hover {
  background: var(--accent-secondary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

button:active {
  transform: translateY(0);
}

button.secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

button.secondary:hover {
  background: var(--border-color);
}

input[type="text"], input[type="number"] {
  flex: 1;
  min-width: 250px;
}

input[type="file"] {
  padding: 10px;
  background: var(--bg-tertiary);
  border: 2px dashed var(--border-color);
  border-radius: var(--border-radius);
  cursor: pointer;
  font-family: var(--font-main);
}

input[type="file"]:hover {
  border-color: var(--accent-primary);
  background: var(--bg-secondary);
}

input[type="checkbox"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
  margin-right: 8px;
}

label {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  font-weight: 500;
}

.terminal-output {
  background: var(--bg-secondary);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 20px;
  margin-top: 20px;
  max-height: 600px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: 0.9rem;
  line-height: 1.6;
  box-shadow: var(--shadow-md);
}

body.retro-theme .terminal-output {
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
}

pre {
  white-space: pre-wrap;
  word-wrap: break-word;
  margin: 0;
  color: var(--text-primary);
}

.output-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.output-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
}

.copy-btn {
  background: var(--success-color);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.2s ease;
}

.copy-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.loading-message {
  display: none;
  color: var(--warning-color);
  font-weight: bold;
  padding: 12px;
  background: rgba(221, 107, 32, 0.1);
  border-radius: var(--border-radius);
  margin-top: 15px;
}

.instructions {
  color: var(--text-primary);
  line-height: 1.7;
}

.instructions h3 {
  color: var(--accent-primary);
  margin-top: 20px;
  margin-bottom: 12px;
  font-size: 1.1rem;
}

.instructions ul {
  margin: 10px 0;
  padding-left: 25px;
}

.instructions li {
  margin: 10px 0;
}

.instructions strong {
  color: var(--accent-primary);
  font-weight: 600;
}

.instructions p {
  margin: 10px 0;
}

.status-footer {
  background: var(--bg-secondary);
  border-top: 2px solid var(--border-color);
  padding: 20px;
  margin-top: 30px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}

.status-container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.status-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-label {
  font-weight: 600;
  color: var(--text-secondary);
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--bg-tertiary);
  border-radius: var(--border-radius);
  font-weight: 500;
}

.status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
}

.status-dot.online {
  background: var(--success-color);
  box-shadow: 0 0 8px var(--success-color);
  animation: pulse-green 2s infinite;
}

.status-dot.offline {
  background: var(--error-color);
  box-shadow: 0 0 8px var(--error-color);
}

.status-dot.checking {
  background: var(--warning-color);
  animation: pulse-orange 1s infinite;
}

@keyframes pulse-green {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

@keyframes pulse-orange {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.status-timestamp {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

body.retro-theme .card {
  background: #0a0a0a;
  border: 2px solid var(--border-color);
}

body.retro-theme button {
  background: #004400;
  border: 1px solid var(--accent-primary);
}

body.retro-theme button:hover {
  background: #006600;
}

body.retro-theme .api-docs-btn {
  background: #004400;
  border: 1px solid var(--accent-primary);
}

body.retro-theme .theme-toggle {
  background: #0a0a0a;
  border: 2px solid var(--border-color);
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .tool-form {
    flex-direction: column;
  }
  
  input[type="text"] {
    width: 100%;
    min-width: 100%;
  }
  
  h1 {
    font-size: 1.5rem;
  }
}
</style>
</head>
<body class="retro-theme">
{% if is_development %}
<div class="dev-banner">
‚ö†Ô∏è DEVELOPMENT MODE - Server: {{ canonical_host }} ‚ö†Ô∏è
</div>
{% endif %}

<div class="container">
  
<div class="header">
  <h1>
    <span>üñ•Ô∏è</span>
    <span>Network Diagnostic Terminal</span>
  </h1>
  <div class="header-controls">
    <button type="button" class="theme-toggle" onclick="toggleTheme()">
      <span id="theme-icon">‚òÄÔ∏è</span>
      <span id="theme-text">Modern Mode</span>
    </button>
    <a href="/api/docs" class="api-docs-btn">
      <span>üìö</span>
      <span>API Docs</span>
    </a>
  </div>
</div>

<div class="card">
  <div class="card-header">Diagnostic Tools</div>
  
  <form method="POST" action="/" class="tool-form" onsubmit="showLoadingMessage()">
    <input type="text" name="target-name" placeholder="Enter hostname or IP address"
           value="{{ target }}" required>
    
    <select name="tool-name" id="tool-select" onchange="toggleOptions()">
      <option value="nslookup" {% if tool == 'nslookup' %}selected{% endif %}>NSLookup</option>
      <option value="ping" {% if tool == 'ping' %}selected{% endif %}>Ping</option>
      <option value="dig" {% if tool == 'dig' %}selected{% endif %}>Dig</option>
      <option value="traceroute" {% if tool == 'traceroute' %}selected{% endif %}>TraceRoute</option>
      <option value="test-netconnection" {% if tool == 'test-netconnection' %}selected{% endif %}>Test Port</option>
      <option value="bulk-nslookup" {% if tool == 'bulk-nslookup' %}selected{% endif %}>Bulk NSLookup</option>
    </select>
    
    <select name="dig-type" id="dig-options" style="display: none;">
      <option value="A" {% if dig_type == 'A' %}selected{% endif %}>A Record</option>
      <option value="MX" {% if dig_type == 'MX' %}selected{% endif %}>MX Record</option>
      <option value="NS" {% if dig_type == 'NS' %}selected{% endif %}>NS Record</option>
      <option value="TXT" {% if dig_type == 'TXT' %}selected{% endif %}>TXT Record</option>
      <option value="CNAME" {% if dig_type == 'CNAME' %}selected{% endif %}>CNAME</option>
      <option value="SOA" {% if dig_type == 'SOA' %}selected{% endif %}>SOA</option>
      <option value="PTR" {% if dig_type == 'PTR' %}selected{% endif %}>PTR</option>
      <option value="AAAA" {% if dig_type == 'AAAA' %}selected{% endif %}>AAAA (IPv6)</option>
    </select>

    <span id="dns-server-inline" style="display:none;">
      <select name="dns-server" id="dns-server-select">
        <optgroup label="Custom DNS Servers">
        {% for dns_server_ip in dns_servers %}
        <option value="{{ dns_server_ip }}" {% if dns_server == dns_server_ip %}selected{% endif %}>{{ dns_server_ip }}</option>
        {% endfor %}
        </optgroup>
        <option value="8.8.8.8" {% if dns_server == "8.8.8.8" %}selected{% endif %}>Google DNS (8.8.8.8)</option>
        <option value="1.1.1.1" {% if dns_server == "1.1.1.1" %}selected{% endif %}>Cloudflare DNS (1.1.1.1)</option>
      </select>
    </span>

    <input type="number" name="port-number" id="port-input" placeholder="Port" 
           value="{{ port }}" min="1" max="65535" style="display:none; width:100px;">
    <select name="port-protocol" id="protocol-select" style="display:none;">
      <option value="tcp" {% if port_protocol == 'tcp' %}selected{% endif %}>TCP</option>
      <option value="udp" {% if port_protocol == 'udp' %}selected{% endif %}>UDP</option>
    </select>

    <button type="submit">Run Diagnostic</button>
    <button type="button" class="secondary" onclick="window.location.href='/'">Clear</button>
  </form>

  <div id="nslookup-ping-option" style="display:none; margin-top:15px;">
    <label>
      <input type="checkbox" name="nslookup-then-ping" value="1" {% if nslookup_then_ping %}checked{% endif %}>
      <span>Ping resolved IP addresses</span>
    </label>
  </div>

  <div id="loading-message" class="loading-message">
    ‚è≥ Running diagnostic... This may take a moment.
  </div>
</div>

<div class="card" id="bulk-block" style="display: none;">
  <div class="card-header">üìÅ Bulk NSLookup (CSV Upload)</div>
  <p style="margin-bottom: 20px; color: var(--text-secondary);">
    Upload a CSV file with one hostname per line (or comma-separated). When processing completes, a download link will be provided below. 
    Large lists may take a while to process ‚Äî please be patient.
  </p>
  
  <form id="bulk-form" method="POST" action="/bulk-nslookup" enctype="multipart/form-data" class="tool-form">
    <input type="file" name="csvfile" accept=".csv,.txt" required style="min-width: 250px;">
    
    <span id="bulk-dns-server-wrapper">
      <label for="bulk-dns-server" style="margin-right: 8px; font-weight: 600;">DNS Server:</label>
      <select name="bulk-dns-server" id="bulk-dns-server">
        <optgroup label="Custom DNS Servers">
        {% for dns_server_ip in dns_servers %}
        <option value="{{ dns_server_ip }}">{{ dns_server_ip }}</option>
        {% endfor %}
        </optgroup>
        <option value="8.8.8.8">Google DNS (8.8.8.8)</option>
        <option value="1.1.1.1">Cloudflare DNS (1.1.1.1)</option>
      </select>
    </span>
    
    <button type="submit">Upload & Process</button>
  </form>
  
  <div style="margin-top: 20px;">
    <label style="display: flex; align-items: center; gap: 10px;">
      <input type="checkbox" name="bulk-ping" id="bulk-ping-check" form="bulk-form">
      <span>Ping each resolved IP (slower but shows connectivity)</span>
    </label>
    
    <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
      <input type="checkbox" name="bulk-reverse" id="bulk-reverse-check" form="bulk-form">
      <span>Perform reverse DNS lookup on each IP</span>
    </label>
  </div>
  
  {% if bulk_results %}
  <div style="margin-top: 25px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
    <h3 style="color: var(--success-color); margin-top: 0;">‚úÖ Bulk Processing Complete</h3>
    <p style="color: var(--text-primary); margin: 10px 0;">
      Your bulk NSLookup results are ready for download.
    </p>
    <a href="/download-bulk" style="display: inline-block; background: var(--success-color); color: white; padding: 12px 24px; border-radius: var(--border-radius); text-decoration: none; font-weight: 600; margin-top: 10px;">
      üì• Download Results (CSV)
    </a>
    
    <div style="margin-top: 20px;">
      <h4 style="color: var(--text-primary); margin-bottom: 10px;">Preview (first 20 lines):</h4>
      <div class="terminal-output" style="max-height: 300px;">
        <pre>{{ bulk_results }}</pre>
      </div>
    </div>
  </div>
  {% endif %}
</div>

{% if result %}
<div class="card">
  <div class="output-header">
    <div class="output-title">üìä Results</div>
    <button class="copy-btn" onclick="copyToClipboard()">Copy</button>
  </div>
  <div class="terminal-output">
    <pre id="terminal-output">{{ result }}</pre>
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-header">üìñ Usage Instructions</div>
  <div class="instructions">
    <h3>Basic Usage</h3>
    <ul>
      <li><strong>NSLookup:</strong> Enter a hostname or IP address to perform a DNS lookup. Select a DNS server from the dropdown.</li>
      <li><strong>Ping:</strong> Test network connectivity by sending ICMP echo requests. Shows latency and packet loss.</li>
      <li><strong>Dig:</strong> Query specific DNS record types (A, MX, NS, TXT, CNAME, SOA, PTR, AAAA).</li>
      <li><strong>TraceRoute:</strong> Trace the network path to a destination, showing each hop along the route.</li>
      <li><strong>Test Port:</strong> Check if a specific TCP or UDP port is open and accepting connections.</li>
      <li><strong>Bulk NSLookup:</strong> Upload a CSV file with multiple hostnames for batch DNS lookups.</li>
    </ul>
    
    <h3>Theme Toggle</h3>
    <p>Click the theme toggle button in the header to switch between Retro (classic terminal) and Modern (professional) themes. Your preference is automatically saved.</p>
    
    <h3>API Access</h3>
    <p>All diagnostic tools are available via REST API. Click the "üìö API Docs" button in the header for complete documentation with code examples in Python, PowerShell, Bash, and cURL.</p>
  </div>
</div>

</div>

<div class="status-footer">
  <div class="status-container">
    <div class="status-item">
      <span class="status-label">DNS Server Status:</span>
      <span id="dns-status" class="status-indicator">
        <span class="status-dot checking"></span>
        <span>Checking {{ status_check_host }}...</span>
      </span>
    </div>
    <div class="status-timestamp">
      Last checked: <span id="last-check-time">Never</span>
    </div>
  </div>
</div>

<script>
function toggleTheme() {
  const body = document.body;
  const themeIcon = document.getElementById('theme-icon');
  const themeText = document.getElementById('theme-text');
  
  if (body.classList.contains('modern-theme')) {
    body.classList.remove('modern-theme');
    body.classList.add('retro-theme');
    themeIcon.textContent = '‚òÄÔ∏è';
    themeText.textContent = 'Modern Mode';
    localStorage.setItem('netdiag-theme', 'retro');
  } else {
    body.classList.remove('retro-theme');
    body.classList.add('modern-theme');
    themeIcon.textContent = 'üåô';
    themeText.textContent = 'Retro Mode';
    localStorage.setItem('netdiag-theme', 'modern');
  }
}

window.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('netdiag-theme') || 'retro';
  const body = document.body;
  const themeIcon = document.getElementById('theme-icon');
  const themeText = document.getElementById('theme-text');
  
  if (savedTheme === 'modern') {
    body.classList.remove('retro-theme');
    body.classList.add('modern-theme');
    themeIcon.textContent = 'üåô';
    themeText.textContent = 'Retro Mode';
  }
  
  toggleOptions();
  fetchDnsStatus();
  scheduleDnsPoll();
});

function toggleOptions() {
  const toolSelect = document.getElementById('tool-select');
  const digOptions = document.getElementById('dig-options');
  const dnsServerInline = document.getElementById('dns-server-inline');
  const portInput = document.getElementById('port-input');
  const protocolSelect = document.getElementById('protocol-select');
  const nslookupPingOption = document.getElementById('nslookup-ping-option');
  const bulkBlock = document.getElementById('bulk-block');
  
  digOptions.style.display = 'none';
  dnsServerInline.style.display = 'none';
  portInput.style.display = 'none';
  protocolSelect.style.display = 'none';
  nslookupPingOption.style.display = 'none';
  if (bulkBlock) bulkBlock.style.display = 'none';
  
  const selectedTool = toolSelect.value;
  
  if (selectedTool === 'dig') {
    digOptions.style.display = 'inline-block';
    dnsServerInline.style.display = 'inline-block';
  } else if (selectedTool === 'nslookup') {
    dnsServerInline.style.display = 'inline-block';
    nslookupPingOption.style.display = 'block';
  } else if (selectedTool === 'test-netconnection') {
    portInput.style.display = 'inline-block';
    protocolSelect.style.display = 'inline-block';
  } else if (selectedTool === 'bulk-nslookup') {
    if (bulkBlock) bulkBlock.style.display = 'block';
  }
}

function showLoadingMessage() {
  const toolSelect = document.getElementById('tool-select');
  const loadingMessage = document.getElementById('loading-message');
  
  if (['ping', 'traceroute', 'bulk-nslookup'].includes(toolSelect.value)) {
    loadingMessage.style.display = 'block';
  }
}

function copyToClipboard() {
  const output = document.getElementById('terminal-output');
  const textArea = document.createElement('textarea');
  textArea.value = output.textContent;
  document.body.appendChild(textArea);
  textArea.select();
  document.execCommand('copy');
  document.body.removeChild(textArea);
  
  const btn = event.target;
  const originalText = btn.textContent;
  btn.textContent = '‚úì Copied!';
  btn.style.background = '#38a169';
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = '';
  }, 2000);
}

function fetchDnsStatus() {
  fetch('/api/dns-status')
    .then(response => response.json())
    .then(data => {
      const statusEl = document.getElementById('dns-status');
      const timeEl = document.getElementById('last-check-time');
      const dot = statusEl.querySelector('.status-dot');
      const text = statusEl.querySelector('span:last-child');
      
      if (data.online) {
        dot.className = 'status-dot online';
        text.textContent = data.message;
      } else {
        dot.className = 'status-dot offline';
        text.textContent = data.message;
      }
      
      const lastCheck = new Date();
      timeEl.textContent = lastCheck.toLocaleTimeString();
    })
    .catch(error => {
      console.error('Status check failed:', error);
      const statusEl = document.getElementById('dns-status');
      const dot = statusEl.querySelector('.status-dot');
      const text = statusEl.querySelector('span:last-child');
      dot.className = 'status-dot offline';
      text.textContent = 'Status check failed';
    });
}

function scheduleDnsPoll() {
  const minInterval = 10 * 60 * 1000;
  const maxInterval = 15 * 60 * 1000;
  const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
  
  setTimeout(() => {
    fetchDnsStatus();
    scheduleDnsPoll();
  }, randomInterval);
}
</script>

</body>
</html>
